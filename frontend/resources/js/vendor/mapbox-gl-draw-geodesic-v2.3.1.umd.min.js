!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@mapbox/mapbox-gl-draw")):"function"==typeof define&&define.amd?define(["exports","@mapbox/mapbox-gl-draw"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).MapboxDrawGeodesic={},t.MapboxDraw)}(this,(function(t,e){"use strict";const{cursors:r,geojsonTypes:o,events:n,meta:i,activeStates:s}=e.constants,a={...e.constants.modes,DRAW_CIRCLE:"draw_circle"},c={CIRCLE_RADIUS:"circleRadius",CIRCLE_HANDLE_BEARING:"circleHandleBearing"};function h(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var u={exports:{}},l=u.exports=function(t,e){if(e||(e=16),void 0===t&&(t=128),t<=0)return"0";for(var r=Math.log(Math.pow(2,t))/Math.log(e),o=2;r===1/0;o*=2)r=Math.log(Math.pow(2,t/o))/Math.log(e)*o;var n=r-Math.floor(r),i="";for(o=0;o<Math.floor(r);o++){i=Math.floor(Math.random()*e).toString(e)+i}if(n){var s=Math.pow(e,n);i=Math.floor(Math.random()*s).toString(e)+i}var a=parseInt(i,e);return a!==1/0&&a>=Math.pow(2,t)?l(t,e):i};l.rack=function(t,e,r){var o=function(o){var i=0;do{if(i++>10){if(!r)throw new Error("too many ID collisions, use more bits");t+=r}var s=l(t,e)}while(Object.hasOwnProperty.call(n,s));return n[s]=o,s},n=o.hats={};return o.get=function(t){return o.hats[t]},o.set=function(t,e){return o.hats[t]=e,o},o.bits=t||128,o.base=e||16,o};var p=h(u.exports);function f(t,e){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(!(e>0))throw new Error("Radius has to be greater then 0");return{id:p(),type:o.FEATURE,properties:{[c.CIRCLE_RADIUS]:e,...r},geometry:{type:o.POLYGON,coordinates:[[t,t,t,t]]}}}function d(t,e){return t===o.POLYGON&&"number"==typeof e[c.CIRCLE_RADIUS]&&e[c.CIRCLE_RADIUS]>0}function g(t){return d(t.geometry.type,t.properties)}function M(t){if(!g(t))throw new Error("GeoJSON is not a circle");return t.geometry.coordinates[0][0]}function y(t){if(!g(t))throw new Error("GeoJSON is not a circle");return t.properties[c.CIRCLE_RADIUS]}var m={exports:{}};!function(t){var e=Math.PI/180,r=180/Math.PI,o=function(t,r){this.lon=t,this.lat=r,this.x=e*t,this.y=e*r},n=function(t){for(var e=Math.pow(10,6),r=0;r<t.length;r++)t[r]=Math.round((t[r]+Number.EPSILON)*e)/e;return t};o.prototype.view=function(){return String(this.lon).slice(0,4)+","+String(this.lat).slice(0,4)},o.prototype.antipode=function(){var t=-1*this.lat,e=this.lon<0?180+this.lon:-1*(180-this.lon);return new o(e,t)};var i=function(){this.coords=[],this.length=0};i.prototype.move_to=function(t){this.length++,this.coords.push(t)};var s=function(t){this.properties=t||{},this.geometries=[]};s.prototype.json=function(){if(this.geometries.length<=0)return{geometry:{type:"LineString",coordinates:null},type:"Feature",properties:this.properties};if(1==this.geometries.length)return{geometry:{type:"LineString",coordinates:this.geometries[0].coords},type:"Feature",properties:this.properties};for(var t=[],e=0;e<this.geometries.length;e++)t.push(this.geometries[e].coords);return{geometry:{type:"MultiLineString",coordinates:t},type:"Feature",properties:this.properties}},s.prototype.wkt=function(){for(var t="",e="LINESTRING(",r=function(t){e+=t[0]+" "+t[1]+","},o=0;o<this.geometries.length;o++){if(0===this.geometries[o].coords.length)return"LINESTRING(empty)";this.geometries[o].coords.forEach(r),t+=e.substring(0,e.length-1)+")"}return t};var a=function(t,e,r){if(!t||void 0===t.x||void 0===t.y)throw new Error("GreatCircle constructor expects two args: start and end objects with x and y properties");if(!e||void 0===e.x||void 0===e.y)throw new Error("GreatCircle constructor expects two args: start and end objects with x and y properties");this.start=new o(t.x,t.y),this.end=new o(e.x,e.y),this.properties=r||{};var n=this.start.x-this.end.x,i=this.start.y-this.end.y,s=Math.pow(Math.sin(i/2),2)+Math.cos(this.start.y)*Math.cos(this.end.y)*Math.pow(Math.sin(n/2),2);if(this.g=2*Math.asin(Math.sqrt(s)),this.g==Math.PI)throw new Error("it appears "+this.start.view()+" and "+this.end.view()+" are 'antipodal', e.g diametrically opposite, thus there is no single route but rather infinite");if(isNaN(this.g))throw new Error("could not calculate great circle between "+t+" and "+e)};a.prototype.interpolate=function(t){var e=Math.sin((1-t)*this.g)/Math.sin(this.g),o=Math.sin(t*this.g)/Math.sin(this.g),n=e*Math.cos(this.start.y)*Math.cos(this.start.x)+o*Math.cos(this.end.y)*Math.cos(this.end.x),i=e*Math.cos(this.start.y)*Math.sin(this.start.x)+o*Math.cos(this.end.y)*Math.sin(this.end.x),s=e*Math.sin(this.start.y)+o*Math.sin(this.end.y),a=r*Math.atan2(s,Math.sqrt(Math.pow(n,2)+Math.pow(i,2)));return[r*Math.atan2(i,n),a]},a.prototype.Arc=function(t,e){var r=[];if(!t||t<=2)r.push([this.start.lon,this.start.lat]),r.push([this.end.lon,this.end.lat]);else for(var o=1/(t-1),a=0;a<t;++a){var c=o*a,h=this.interpolate(c);r.push(h)}for(var u=!1,l=0,p=e&&e.offset?e.offset:10,f=180-p,d=-180+p,g=360-p,M=1;M<r.length;++M){var y=r[M-1][0],m=r[M][0],E=Math.abs(m-y);E>g&&(m>f&&y<d||y>f&&m<d)?u=!0:E>l&&(l=E)}var I=[];if(u&&l<p){var C=[];I.push(C);for(var v=0;v<r.length;++v){var x=parseFloat(r[v][0]);if(v>0&&Math.abs(x-r[v-1][0])>g){var L=parseFloat(r[v-1][0]),S=parseFloat(r[v-1][1]),_=parseFloat(r[v][0]),w=parseFloat(r[v][1]);if(L>-180&&L<d&&180==_&&v+1<r.length&&r[v-1][0]>-180&&r[v-1][0]<d){C.push([-180,r[v][1]]),v++,C.push([r[v][0],r[v][1]]);continue}if(L>f&&L<180&&-180==_&&v+1<r.length&&r[v-1][0]>f&&r[v-1][0]<180){C.push([180,r[v][1]]),v++,C.push([r[v][0],r[v][1]]);continue}if(L<d&&_>f){var N=L;L=_,_=N;var R=S;S=w,w=R}if(L>f&&_<d&&(_+=360),L<=180&&_>=180&&L<_){var b=(180-L)/(_-L),D=b*w+(1-b)*S;C.push([r[v-1][0]>f?180:-180,D]),(C=[]).push([r[v-1][0]>f?-180:180,D]),I.push(C)}else C=[],I.push(C);C.push([x,r[v][1]])}else C.push([r[v][0],r[v][1]])}}else{var T=[];I.push(T);for(var P=0;P<r.length;++P)T.push([r[P][0],r[P][1]])}for(var A=new s(this.properties),O=0;O<I.length;++O){var G=new i;A.geometries.push(G);for(var F=I[O],U=0;U<F.length;++U)G.move_to(n(F[U]))}return A},t.exports.Coord=o,t.exports.Arc=s,t.exports.GreatCircle=a}(m);var E=h(m.exports);function I(t,e){return t[0]===e[0]&&t[1]===e[1]}function C(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:32;var r;const n=(r=t).slice(0,-1).map(((t,e)=>[t,r[e+1]])).filter((t=>!I(t[0],t[1]))).map((t=>new E.GreatCircle({x:t[0][0],y:t[0][1]},{x:t[1][0],y:t[1][1]}).Arc(e,{offset:90}).json()));let i=0;const s=n.map((t=>{if(t.geometry.type===o.MULTI_LINE_STRING){const e=i,r=i+(t.geometry.coordinates[0][0][0]>t.geometry.coordinates[1][0][0]?1:-1),o=[...t.geometry.coordinates[0].map((t=>[t[0]+360*e,t[1]])),...t.geometry.coordinates[1].map((t=>[t[0]+360*r,t[1]]))];return i=r,o}return t.geometry.coordinates.map((t=>[t[0]+360*i,t[1]]))})).flat();return s.filter(((t,e)=>e===s.length-1||!I(t,s[e+1])))}const v=6371e3;function x(t){return t/180*Math.PI}function L(t){return t/Math.PI*180}function S(t,e){if(r=t,o=e,!(Math.abs(r[0]-o[0])>Number.EPSILON||Math.abs(r[1]-o[1])>Number.EPSILON))return NaN;var r,o;const n=x(t[1]),i=x(e[1]),s=x(e[0]-t[0]),a=Math.cos(n)*Math.sin(i)-Math.sin(n)*Math.cos(i)*Math.cos(s),c=Math.sin(s)*Math.cos(i),h=L(Math.atan2(c,a));return(h+360)%360}const _=6371.0088;function w(t,e){return function(t,e){const r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:v,o=x(t[1]),n=x(t[0]),i=x(e[1]),s=i-o,a=x(e[0])-n,c=Math.sin(s/2)*Math.sin(s/2)+Math.cos(o)*Math.cos(i)*Math.sin(a/2)*Math.sin(a/2);return r*(2*Math.atan2(Math.sqrt(c),Math.sqrt(1-c)))}(t,e,_)}function N(t,e,r){return function(t,e,r){const o=e/(arguments.length>3&&void 0!==arguments[3]?arguments[3]:v),n=x(r),i=x(t[1]),s=x(t[0]),a=Math.sin(i)*Math.cos(o)+Math.cos(i)*Math.sin(o)*Math.cos(n),c=Math.asin(a),h=Math.sin(n)*Math.sin(o)*Math.cos(i),u=Math.cos(o)-Math.sin(i)*a,l=s+Math.atan2(h,u),p=L(c);return[L(l),p]}(t,e,r,_)}const R=32,b=45;function D(t){return d(t.type,t.properties)}function T(t,r){r={steps:R,...r};const n=t.properties,a=t.geometry.type,h=t.geometry.coordinates,u=n.parent||n.id,l=r.ctx.store.get(u);if(a===o.POINT)return D(l)?[]:n.meta===i.MIDPOINT?function(){const e=n.coord_path,r=(h=e,h.split(".").map(((t,e,r)=>e===r.length-1?(parseInt(t,10)-1).toString():t)).join(".")),i=function(t,e){if(t.type!==o.POLYGON&&t.type!==o.MULTI_POLYGON)return e;try{return t.getCoordinate(e),e}catch(t){return e.split(".").map(((t,e,r)=>e===r.length-1?"0":t)).join(".")}}(l,e),s=l.getCoordinate(r),a=l.getCoordinate(i),c=function(t,e){const r=x(t[1]),o=x(t[0]),n=x(e[1]),i=x(e[0]-t[0]),s=Math.cos(r),a=0,c=Math.sin(r),h={x:s+Math.cos(n)*Math.cos(i),y:a+Math.cos(n)*Math.sin(i),z:c+Math.sin(n)},u=Math.atan2(h.z,Math.sqrt(h.x*h.x+h.y*h.y)),l=o+Math.atan2(h.y,h.x),p=L(u);return[L(l),p]}(s,a);var h;return[{...t,properties:{...n,lng:c[0],lat:c[1]},geometry:{...t.geometry,coordinates:c}}]}():[t];if(a===o.LINE_STRING)return function(){const e=C(h,r.steps);return[{...t,geometry:{...t.geometry,coordinates:e}}]}();if(a===o.POLYGON)return D(l)?function(){const o=l.toGeoJSON(),i=M(o),a=y(o),h=l[c.CIRCLE_HANDLE_BEARING]||b,u=function(t,e,r,o){const n=[];for(let i=0;i<o;++i)n.push(N(t,e,r+360*-i/o));return n.push(n[0]),n}(i,a,h,4*r.steps),p={...t,geometry:{...t.geometry,coordinates:[u]}};if(n.active===s.ACTIVE){return[p,...[i,N(i,a,h)].map(((t,o)=>e.lib.createVertex(n.id,t,`0.${o}`,function(t){if(!r.selectedPaths)return!1;return-1!==r.selectedPaths.indexOf(t)}(`0.${o}`))))]}return[p]}():function(){const e=h.map((t=>C(t)));return[{...t,geometry:{...t.geometry,coordinates:e}}]}();if(0===a.indexOf(o.MULTI_PREFIX))return function(){const e=a.replace(o.MULTI_PREFIX,""),i=h.map((t=>T({type:o.FEATURE,properties:n,geometry:{type:e,coordinates:t}},r))).flat().map((t=>t.geometry.coordinates));return[{...t,geometry:{...t.geometry,coordinates:i}}]}()}function P(t){const e={...t};return e.toDisplayFeatures=function(e,r,o){t.toDisplayFeatures.call(this,e,r,(t=>{T(t,{ctx:this._ctx}).forEach(o)}))},e}function A(t){const e={...t};return e.toDisplayFeatures=function(e,r,o){t.toDisplayFeatures.call(this,e,r,(t=>{T(t,{ctx:this._ctx}).forEach(o)}))},e}const O={enable(t){setTimeout((()=>{t.map&&t.map.dragPan&&t._ctx&&t._ctx.store&&t._ctx.store.getInitialConfigValue&&t._ctx.store.getInitialConfigValue("dragPan")&&t.map.dragPan.enable()}),0)},disable(t){setTimeout((()=>{t.map&&t.map.doubleClickZoom&&t.map.dragPan.disable()}),0)}},G={};function F(t){const e={...t};return e.toDisplayFeatures=function(e,r,o){t.toDisplayFeatures.call(this,e,r,(t=>{T(t,{ctx:this._ctx}).forEach(o)}))},e}function U(t){const e={...t};return e.toDisplayFeatures=function(e,r,o){t.toDisplayFeatures.call(this,e,r,(t=>{T(t,{ctx:this._ctx}).forEach(o)}))},e}function j(t){const e={...t};return e.dragVertex=function(e,r,o){const n=e.feature.toGeoJSON();if(g(n))if("0.1"===e.selectedCoordPaths[0]){const t=M(n),o=[r.lngLat.lng,r.lngLat.lat],i=w(t,o),s=S(t,o);e.feature.properties[c.CIRCLE_RADIUS]=i,e.feature[c.CIRCLE_HANDLE_BEARING]=s,e.feature.changed()}else t.dragFeature.call(this,e,r,o);else t.dragVertex.call(this,e,r,o)},e.toDisplayFeatures=function(e,r,o){t.toDisplayFeatures.call(this,e,r,(t=>{T(t,{ctx:this._ctx,selectedPaths:e.selectedCoordPaths}).forEach(o)}))},e}G.onSetup=function(t){return this.clearSelectedFeatures(),e.lib.doubleClickZoom.disable(this),O.disable(this),this.updateUIClasses({mouse:r.ADD}),this.setActionableState(),{}},G.onMouseDown=G.onTouchStart=function(t,e){const r=[e.lngLat.lng,e.lngLat.lat],o=this.newFeature(f(r,Number.EPSILON));this.addFeature(o),t.circle=o},G.onDrag=G.onTouchMove=function(t,e){if(t.circle){const r=M(t.circle.toGeoJSON()),o=[e.lngLat.lng,e.lngLat.lat],n=w(r,o),i=S(r,o);t.circle.properties[c.CIRCLE_RADIUS]=n,t.circle[c.CIRCLE_HANDLE_BEARING]=i,t.circle.changed()}},G.onMouseUp=G.onTouchEnd=function(t,e){return this.map.fire(n.CREATE,{features:[t.circle.toGeoJSON()]}),this.changeMode(a.SIMPLE_SELECT,{featureIds:[t.circle.id]})},G.onKeyUp=function(t,r){e.lib.CommonSelectors.isEscapeKey(r)?(t.circle&&this.deleteFeature([t.circle.id],{silent:!0}),this.changeMode(a.SIMPLE_SELECT)):e.lib.CommonSelectors.isEnterKey(r)&&this.changeMode(a.SIMPLE_SELECT,{featureIds:[t.circle.id]})},G.onStop=function(){this.updateUIClasses({mouse:r.NONE}),e.lib.doubleClickZoom.enable(this),O.enable(this),this.activateUIButton()},G.toDisplayFeatures=function(t,e,r){if(t.circle){const r=e.properties.id===t.circle.id;e.properties.active=r?s.ACTIVE:s.INACTIVE}(t=>{T(t,{ctx:this._ctx}).forEach(r)})(e)};const J={};J.onSetup=function(){return this.setActionableState(),{}},J.toDisplayFeatures=function(t,e,r){(t=>{T(t,{ctx:this._ctx}).forEach(r)})(e)},t.createCircle=f,t.enable=function(t){return{...t,[a.DRAW_LINE_STRING]:P(t[a.DRAW_LINE_STRING]),[a.DRAW_POLYGON]:A(t[a.DRAW_POLYGON]),[a.DRAW_CIRCLE]:G,[a.DRAW_POINT]:F(t[a.DRAW_POINT]),[a.SIMPLE_SELECT]:U(t[a.SIMPLE_SELECT]),[a.DIRECT_SELECT]:j(t[a.DIRECT_SELECT]),[a.STATIC]:J}},t.getCircleCenter=M,t.getCircleRadius=y,t.isCircle=g,t.isCircleByTypeAndProperties=d,t.setCircleCenter=function(t,e){if(!g(t))throw new Error("GeoJSON is not a circle");t.geometry.coordinates=[[e,e,e,e]]},t.setCircleRadius=function(t,e){if(!g(t))throw new Error("GeoJSON is not a circle");t.properties[c.CIRCLE_RADIUS]=e}}));
